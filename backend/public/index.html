<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boveda: Patient Records Module</title>
    <link rel="icon" href="logo.png" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body class="bg-slate-50 text-slate-800">
    <script>
        // This inline script runs before the page is rendered to prevent a "flash" of the login screen.
        try {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
            document.documentElement.style.setProperty('--login-display', isLoggedIn ? 'none' : 'flex');
            document.documentElement.style.setProperty('--app-display', isLoggedIn ? 'block' : 'none');
        } catch (e) {
            // sessionStorage might not be available in some private browsing modes or if cookies are disabled.
            console.error('Could not access sessionStorage.', e);
        }
    </script>

    <noscript>
        <div class="p-4 text-center bg-red-100 text-red-800">This application requires JavaScript to function. Please enable it in your browser settings.</div>
    </noscript>

    <div id="login-container" style="display: var(--login-display, flex);" class="items-center justify-center min-h-screen bg-slate-100 p-4">
        <div class="w-full max-w-sm p-8 space-y-6 bg-white rounded-lg shadow-lg border border-slate-200">
            <div class="text-center">
                <img src="logo.png" alt="Boveda Logo" class="w-16 h-16 mx-auto">
                <h2 class="mt-4 text-2xl font-bold text-center text-slate-900">
                    Boveda Records Module
                </h2>
                <p class="mt-2 text-sm text-center text-slate-500">
                    Sign in to access your dashboard.
                </p>
            </div>
            <form id="loginForm" class="mt-6 space-y-4">
                <div class="space-y-2">
                    <label for="username" class="text-sm font-medium text-slate-700">Username</label>
                    <input id="username" name="username" type="text" required
                        class="relative block w-full px-3 py-2 text-slate-900 placeholder-slate-400 bg-slate-50 border border-slate-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div class="space-y-2">
                    <label for="password" class="text-sm font-medium text-slate-700">Password</label>
                    <input id="password" name="password" type="password" required
                        class="relative block w-full px-3 py-2 text-slate-900 placeholder-slate-400 bg-slate-50 border border-slate-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>

                <p id="loginError" class="text-sm text-red-600 h-4"></p>

                <div>
                    <button type="submit" class="btn btn-primary w-full justify-center">Sign In</button>
                </div>
            </form>
        </div>
    </div>

    <div id="app-container" style="display: var(--app-display, none);">
        <div class="main-container p-4 sm:p-6 lg:p-8">
            <header class="flex flex-col gap-4 mb-4">
                <div class="flex items-center justify-between w-full">
                    <a href="#" id="homeLink" class="flex items-center gap-4 group">
                        <img src="logo.png" alt="Boveda Logo" class="h-8 w-8">
                        <h1 class="text-2xl font-bold text-slate-900 group-hover:text-blue-600 transition-colors">
                            Patient
                            Records</h1>
                    </a>

                    <div class="flex items-center gap-2 ml-auto">
                        <button id="deleteSelectedBtn" class="btn btn-danger hidden">
                            <i class="fa-solid fa-trash-can"></i>
                            <span id="deleteSelectedCount">Delete Selected</span>
                        </button>
                        <button id="newPatientBtn" class="btn btn-primary">
                            <i class="fa-solid fa-plus"></i>
                            <span>Create from PDF</span>
                        </button>
                        <button id="logoutBtn" class="btn btn-secondary">
                            <i class="fa-solid fa-right-from-bracket"></i>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
            </header>

            <div id="dashboardStatsContainer" class="bg-white rounded-lg border border-slate-200 mb-6 shadow-sm">
                <div class="border-b border-slate-200">
                    <nav id="dashboardTabs" class="flex gap-6 -mb-px px-6">
                        <button data-tab="overview" class="dashboard-tab active">Overview</button>
                        <button data-tab="diagnoses" class="dashboard-tab">Diagnoses</button>
                        <button data-tab="categories" class="dashboard-tab">Categories</button>
                    </nav>
                </div>

                <div class="p-6">
                    <div id="overviewPanel" class="dashboard-panel">
                        <div id="overviewStats" class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        </div>
                    </div>
                    <div id="diagnosesPanel" class="dashboard-panel hidden">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Most Common Diagnoses</h3>
                        <ul id="topDiagnosesList" class="space-y-2">
                        </ul>
                    </div>
                    <div id="categoriesPanel" class="dashboard-panel hidden">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Records by Category</h3>
                        <ul id="categoriesList" class="space-y-2">
                        </ul>
                    </div>
                </div>
            </div>

            <div id="listControls" class="flex items-center justify-between w-full mb-4">
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="searchInput" placeholder="Search by name..." class="search-input">
                    </div>
                    <p id="recordCount" class="record-count-badge">0 Records</p>
                </div>

                <div class="flex items-center justify-end gap-2">
                    <div class="relative">
                        <button id="categoryFilterBtn" class="btn btn-secondary w-48 justify-between">
                            <i class="fa-solid fa-filter"></i>
                            <span id="categoryFilterText">All Categories</span>
                            <i class="fa-solid fa-chevron-down"></i>
                        </button>
                        <div id="categoryFilterMenu" class="dropdown-menu hidden">
                        </div>
                    </div>
                    <div class="sort-controls flex items-center gap-1">
                        <div class="relative">
                            <button id="sortDropdownBtn" class="btn btn-secondary w-48 justify-between">
                                <i class="fa-solid fa-sort"></i>
                                <span id="sortByText">Patient Name</span>
                                <i class="fa-solid fa-chevron-down"></i>
                            </button>
                            <div id="sortDropdownMenu" class="dropdown-menu hidden">
                                <a href="#" class="dropdown-item" data-sort="name">Patient Name</a>
                                <a href="#" class="dropdown-item" data-sort="patient_info.patient_record_number">Record
                                    #</a>
                                <a href="#" class="dropdown-item" data-sort="patient_info.date_of_birth">Date of
                                    Birth</a>
                                <a href="#" class="dropdown-item" data-sort="created_at">Date Created</a>
                                <a href="#" class="dropdown-item" data-sort="updated_at">Last Modified</a>
                            </div>
                        </div>
                        <button id="sortOrderBtn" class="btn btn-secondary !p-2">
                            <i id="sortOrderIcon" class="fa-solid fa-arrow-up-long"></i>
                        </button>
                    </div>
                </div>
            </div>

            <main class="main-content bg-white rounded-lg shadow-sm">
                <div id="patientListContainer" class="overflow-x-auto">
                </div>
                <footer id="paginationContainer"
                    class="p-4 border-t border-slate-200 flex items-center justify-between">
                </footer>
            </main>

            <div id="patientDetailContainer" class="hidden">
                <div id="patientDetailContent"></div>
                <section id="dashboardContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                </section>
                <div id="recordContainer"></div>
            </div>
        </div>

        <div id="uploadModal"
            class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 z-40 flex items-center justify-center p-4">
            <div
                class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl border border-slate-200 overflow-hidden max-h-screen overflow-y-auto">
                <div class="p-5 border-b border-slate-200">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800">
                        <i class="fa-solid fa-notes-medical text-blue-500"></i>
                        <span>Create New Patient Record</span>
                    </h2>
                    <p class="text-sm text-slate-500 mt-1 ml-9">Follow the steps below to upload and extract patient
                        data.</p>
                </div>

                <div class="p-4 sm:p-6">
                    <div class="flex items-start">
                        <div class="step-item flex-1 text-center" data-step="1">
                            <div class="relative mb-2">
                                <div class="step-line"></div>
                                <div
                                    class="step-circle w-8 h-8 rounded-full mx-auto bg-white border-2 relative z-10 flex items-center justify-center font-bold">
                                    1</div>
                            </div>
                            <p class="step-title font-bold text-xs sm:text-base transition-colors">Upload</p>
                        </div>
                        <div class="step-item flex-1 text-center" data-step="2">
                            <div class="relative mb-2">
                                <div class="step-line"></div>
                                <div
                                    class="step-circle w-8 h-8 rounded-full mx-auto bg-white border-2 relative z-10 flex items-center justify-center font-bold">
                                    2</div>
                            </div>
                            <p class="step-title font-bold text-xs sm:text-base transition-colors">Process</p>
                        </div>
                        <div class="step-item flex-1 text-center" data-step="3">
                            <div class="relative mb-2">
                                <div
                                    class="step-circle w-8 h-8 rounded-full mx-auto bg-white border-2 relative z-10 flex items-center justify-center font-bold">
                                    3</div>
                            </div>
                            <p class="step-title font-bold text-xs sm:text-base transition-colors">Review</p>
                        </div>
                    </div>
                </div>

                <div class="p-4 sm:p-6 bg-slate-50 min-h-[300px]">
                    <div id="step-1" class="modal-step">
                        <h3 class="font-semibold text-lg text-slate-700 mb-2 flex items-center gap-2"><i
                                class="fa-solid fa-file-arrow-up text-slate-400"></i> <span>Select Document</span></h3>
                        <p class="text-sm text-slate-500 mb-6">Choose the medical record PDF you want to process.</p>

                        <div id="dropZone"
                            class="border-2 border-dashed border-slate-300 rounded-lg transition-colors duration-200 ease-in-out">
                            <div id="uploadPrompt" class="p-6 text-center cursor-pointer">
                                <i class="fa-solid fa-cloud-arrow-up text-4xl text-slate-400 mb-3"></i>
                                <p class="text-slate-600 font-medium">Drag & drop your PDF here</p>
                                <p class="text-sm text-slate-400 my-1">or</p>
                                <input type="file" id="pdfFile" accept=".pdf" class="hidden" />
                                <button type="button" id="browseBtn"
                                    class="text-sm font-semibold text-blue-600 bg-blue-100 px-4 py-2 rounded-md hover:bg-blue-200 transition-colors">
                                    Browse File
                                </button>
                            </div>
                            <div id="filePreview" class="hidden p-4 w-full bg-white flex items-center justify-between">
                                <div class="flex items-center gap-3 overflow-hidden">
                                    <i class="fa-solid fa-file-pdf text-red-500 text-2xl"></i>
                                    <div class="truncate">
                                        <p id="previewFileName" class="text-sm font-medium text-slate-800 truncate"></p>
                                        <p id="previewFileSize" class="text-xs text-slate-500"></p>
                                    </div>
                                </div>
                                <button type="button" id="removeFileBtn"
                                    class="text-slate-400 hover:text-red-600 transition-colors p-1 rounded-full">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                        </div>
                        <p id="fileError" class="text-red-500 text-sm mt-1 h-5"></p>

                        <h3 class="font-semibold text-lg text-slate-700 mb-2 mt-6 flex items-center gap-2"><i
                                class="fa-solid fa-cog text-slate-400"></i> <span>Upload Settings</span></h3>
                        <p class="text-sm text-slate-500 mb-4">Specify the type of document for better processing.</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <label
                                class="p-4 border border-slate-300 rounded-lg cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-colors has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                                <input type="radio" name="documentType" value="military" class="mr-2" checked>
                                <span class="font-medium">Military Personnel</span>
                                <p class="text-xs text-slate-500 mt-1">For records where the patient is the service
                                    member.</p>
                            </label>
                            <label
                                class="p-4 border border-slate-300 rounded-lg cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-colors has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                                <input type="radio" name="documentType" value="dependent" class="mr-2">
                                <span class="font-medium">Sponsored Dependent</span>
                                <p class="text-xs text-slate-500 mt-1">For records where the patient is a
                                    civilian/dependent.</p>
                            </label>
                        </div>
                    </div>

                    <div id="step-2" class="modal-step">
                        <div class="text-center py-8">
                            <svg class="animate-spin h-12 w-12 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            <p class="text-lg font-semibold text-slate-700 mt-6">Processing Document...</p>
                            <p class="text-sm text-slate-500">The AI is extracting information. Please wait.</p>
                            <div id="processing-summary"
                                class="mt-6 text-left max-w-sm mx-auto bg-slate-100 border border-slate-200 rounded-lg p-3 text-sm">
                                <h4 class="font-semibold text-slate-600 mb-2 border-b border-slate-300 pb-1">Upload
                                    Configuration</h4>
                                <div class="space-y-1">
                                    <p><strong class="font-medium text-slate-500 w-28 inline-block">File:</strong> <span
                                            id="summary-file-name" class="text-slate-700"></span></p>
                                    <p><strong class="font-medium text-slate-500 w-28 inline-block">Document
                                            Type:</strong> <span id="summary-doc-type" class="text-slate-700"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="step-3" class="modal-step">
                        <div class="text-center py-12">
                            <i class="fa-solid fa-check-circle text-6xl text-green-500"></i>
                            <p class="text-lg font-semibold text-slate-700 mt-6">Extraction Complete</p>
                            <p class="text-sm text-slate-500">The extracted data is ready for your review.</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 border-t border-slate-200 flex justify-end gap-3">
                    <button id="backBtn"
                        class="px-3 py-1.5 text-sm rounded-md bg-slate-200 text-slate-700 font-medium hover:bg-slate-300 transition-colors hidden mr-auto">
                        Back
                    </button>
                    <button id="cancelBtn"
                        class="px-3 py-1.5 text-sm rounded-md bg-slate-200 text-slate-700 font-medium hover:bg-slate-300 transition-colors">Cancel</button>
                    <button id="primaryBtn"
                        class="px-3 py-1.5 text-sm rounded-md bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors text-center">Next:
                        Select Model</button>
                </div>
            </div>
        </div>

        <!-- Grammar and Spelling Modal -->
        <div id="grammarModal"
            class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 z-50 flex items-center justify-center p-4">
            <div
                class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl border border-slate-200 overflow-hidden max-h-[90vh] flex flex-col">
                <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                    <h2 class="flex items-center gap-3 text-xl font-semibold text-slate-800">
                        <i class="fa-solid fa-spell-check text-blue-500"></i>
                        <span>Grammar & Spelling Review</span>
                    </h2>
                    <button id="grammarModalCloseBtn"
                        class="text-slate-400 hover:text-red-600 transition-colors p-1 rounded-full">
                        <i class="fa-solid fa-xmark fa-lg"></i>
                    </button>
                </div>
                <div class="flex-grow grid grid-cols-1 md:grid-cols-3 gap-4 p-4 overflow-y-auto">
                    <div class="md:col-span-2 flex flex-col h-full">
                        <label for="grammarModalTextarea" class="block font-medium text-sm text-gray-700 mb-2">Editable
                            Text</label>
                        <div id="grammarEditorContainer" class="relative w-full flex-grow min-h-[400px]">
                            <div id="grammarModalBackdrop"
                                class="absolute inset-0 p-2 border border-transparent rounded-md overflow-auto pointer-events-none whitespace-pre-wrap break-words font-mono text-sm leading-relaxed"></div>
                            <textarea id="grammarModalTextarea" spellcheck="false" class="absolute inset-0 w-full h-full p-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-transparent resize-none font-mono text-sm leading-relaxed"></textarea>
                        </div>
                    </div>
                    <div id="grammarModalSuggestions" class="md:col-span-1 bg-slate-50 border border-slate-200 rounded-md p-3 h-full overflow-y-auto"></div>
                </div>
                <div class="bg-white p-4 border-t border-slate-200 flex justify-end gap-3">
                    <button id="grammarModalFormatBtn" class="btn btn-secondary mr-auto hidden">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> Format Text
                    </button>
                    <button id="grammarModalApplyBtn" class="btn btn-primary">Apply & Close</button>
                </div>
            </div>
        </div>

        <footer class="text-center py-6 text-slate-400 text-sm">
            <p>&copy; 2025 Boveda Patient Records Module. All Rights Reserved.</p>
            <p>Powered by Cubeworks Technology Consulting and Solutions, Inc.</p>
        </footer>

        <script src="script.js"></script>
</body>

</html>